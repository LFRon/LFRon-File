From 4638725d1a1c220ea214cbe28b725133dd9bec92 Mon Sep 17 00:00:00 2001
From: Aaron Erhardt <aer@tuxedocomputers.com>
Date: Mon, 20 Oct 2025 07:47:44 +0200
Subject: [PATCH] drm: Add quirk for IBP Gen10 AMD and IB Max

Signed-off-by: Aaron Erhardt <aer@tuxedocomputers.com>
---
 .../gpu/drm/amd/display/amdgpu_dm/amdgpu_dm_crtc.c  | 13 +++++++++++++
 1 file changed, 13 insertions(+)

diff --git a/drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm_crtc.c b/drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm_crtc.c
index 2551823382f8..00190529a3bd 100644
--- a/drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm_crtc.c
+++ b/drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm_crtc.c
@@ -23,6 +23,7 @@
  * Authors: AMD
  *
  */
+#include "linux/dmi.h"
 #include <drm/drm_vblank.h>
 #include <drm/drm_atomic_helper.h>
 
@@ -318,8 +319,19 @@ static inline int amdgpu_dm_crtc_set_vblank(struct drm_crtc *crtc, bool enable)
 	irq_type = amdgpu_display_crtc_idx_to_irq_type(adev, acrtc->crtc_id);
 
 	if (enable) {
 		struct dc *dc = adev->dm.dc;
 		struct drm_vblank_crtc *vblank = drm_crtc_vblank_crtc(crtc);
+		/*
+		 * Quirk for IBP Gen10 AMD and IB Max
+		 * Devices with vblank->config.disable_immediate == true
+		 * were not affected, so ignore them.
+		 */
+		if (!vblank->config.disable_immediate &&
+		   (dmi_match(DMI_BOARD_NAME, "XxKK4NAx_XxSP4NAx") ||
+		    dmi_match(DMI_BOARD_NAME, "XxHP4NAx") ||
+		    dmi_match(DMI_BOARD_NAME, "X5KK45xS_X5SP45xS")))
+			drm_crtc_vblank_restore(crtc);
+
 		struct psr_settings *psr = &acrtc_state->stream->link->psr_settings;
 		struct replay_settings *pr = &acrtc_state->stream->link->replay_settings;
 		bool sr_supported = (psr->psr_version != DC_PSR_VERSION_UNSUPPORTED) ||
-- 
GitLab

